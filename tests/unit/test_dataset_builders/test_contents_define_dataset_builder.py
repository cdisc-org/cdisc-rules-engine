import pytest
import pandas as pd
from unittest.mock import MagicMock, patch
from cdisc_rules_engine.dataset_builders.contents_define_dataset_builder import (
    ContentsDefineDatasetBuilder,
)
from cdisc_rules_engine.services.data_services import DummyDataService
from cdisc_rules_engine.models.library_metadata_container import (
    LibraryMetadataContainer,
)
from cdisc_rules_engine.models.sdtm_dataset_metadata import SDTMDatasetMetadata
from conftest import mock_data_service
from cdisc_rules_engine.utilities.rule_processor import RuleProcessor
from cdisc_rules_engine.services.cache.in_memory_cache_service import (
    InMemoryCacheService,
)
from cdisc_rules_engine.dummy_models.dummy_dataset import DummyDataset
from cdisc_rules_engine.models.rule_conditions import ConditionCompositeFactory

datasets = [
    {
        "filename": "ecaa.xpt",
        "label": "Exposure as Collected AA",
        "domain": "EC",
        "variables": [
            {
                "name": "STUDYID",
                "label": "Study Identifier",
                "type": "char",
                "length": 12,
            },
            {
                "name": "DOMAIN",
                "label": "Domain Abbreviation",
                "type": "char",
                "length": 2,
            },
            {
                "name": "USUBJID",
                "label": "Unique Subject Identifier",
                "type": "char",
                "length": 8,
            },
            {
                "name": "SPDEVID",
                "label": "Sponsor Device Identifier",
                "type": "char",
                "length": 200,
            },
            {"name": "ECSEQ", "label": "Sequence Number", "type": "num", "length": 8},
            {
                "name": "ECTRT",
                "label": "Name of Treatment",
                "type": "char",
                "length": 10,
            },
            {"name": "ECDOSE", "label": "Dose", "type": "num", "length": 8},
            {
                "name": "ECSTDTC",
                "label": "Start Date/Time of Treatment",
                "type": "char",
                "length": 10,
            },
        ],
        "records": {
            "STUDYID": [
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
            ],
            "DOMAIN": ["EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC"],
            "USUBJID": [
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
            ],
            "SPDEVID": [
                "Different",
                "Different",
                "Same as split, different supp",
                "Same as split, same supp",
                "Same as next row, different supp",
                "Same as prev row, different supp",
                "Same as next row, same supp",
                "Same as prev row, same supp",
            ],
            "ECSEQ": [1, 2, 3, 4, 5, 6, 7, 8],
            "ECTRT": [
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
                "ZANOMALINE",
            ],
            "ECDOSE": [5, 5, 5, 5, 5, 5, 5, 5],
            "ECSTDTC": [
                "2012-11-30",
                "2012-12-01",
                "2012-12-02",
                "2012-12-03",
                "2012-12-04",
                "2012-12-04",
                "2012-12-05",
                "2012-12-05",
            ],
        },
    },
    {
        "filename": "ecbb.xpt",
        "label": "Exposure as Collected BB",
        "domain": "EC",
        "variables": [
            {
                "name": "STUDYID",
                "label": "Study Identifier",
                "type": "char",
                "length": 12,
            },
            {
                "name": "DOMAIN",
                "label": "Domain Abbreviation",
                "type": "char",
                "length": 2,
            },
            {
                "name": "USUBJID",
                "label": "Unique Subject Identifier",
                "type": "char",
                "length": 8,
            },
            {
                "name": "SPDEVID",
                "label": "Sponsor Device Identifier",
                "type": "char",
                "length": 200,
            },
            {"name": "ECSEQ", "label": "Sequence Number", "type": "num", "length": 8},
            {
                "name": "ECTRT",
                "label": "Name of Treatment",
                "type": "char",
                "length": 10,
            },
            {"name": "ECDOSE", "label": "Dose", "type": "num", "length": 8},
            {
                "name": "ECSTDTC",
                "label": "Start Date/Time of Treatment",
                "type": "char",
                "length": 10,
            },
        ],
        "records": {
            "STUDYID": ["CDISCPILOT01", "CDISCPILOT01", "CDISCPILOT01"],
            "DOMAIN": ["EC", "EC", "EC"],
            "USUBJID": ["CDISC001", "CDISC001", "CDISC001"],
            "SPDEVID": [
                "Different",
                "Same as split, different supp",
                "Same as split, same supp",
            ],
            "ECSEQ": [11, 13, 14],
            "ECTRT": ["ZANOMALINE", "ZANOMALINE", "ZANOMALINE"],
            "ECDOSE": [5, 5, 5],
            "ECSTDTC": ["2013-12-01", "2012-12-02", "2012-12-03"],
        },
    },
    {
        "filename": "suppec.xpt",
        "label": "Supplemental Qualifiers for EC",
        "domain": "EC",
        "variables": [
            {
                "name": "STUDYID",
                "label": "Study Identifier",
                "type": "char",
                "length": 12,
            },
            {
                "name": "RDOMAIN",
                "label": "Related Domain Abbreviation",
                "type": "char",
                "length": 6,
            },
            {
                "name": "USUBJID",
                "label": "Unique Subject Identifier",
                "type": "char",
                "length": 8,
            },
            {
                "name": "IDVAR",
                "label": "Identifying Variable",
                "type": "char",
                "length": 200,
            },
            {
                "name": "IDVARVAL",
                "label": "Identifying Variable Value",
                "type": "char",
                "length": 200,
            },
            {
                "name": "QNAM",
                "label": "Qualifier Variable Name",
                "type": "char",
                "length": 8,
            },
            {
                "name": "QLABEL",
                "label": "Qualifier Variable Label",
                "type": "char",
                "length": 40,
            },
            {"name": "QVAL", "label": "Data Value", "type": "char", "length": 200},
            {"name": "QORIG", "label": "Origin", "type": "char", "length": 13},
            {"name": "QEVAL", "label": "Evaluator", "type": "char", "length": 200},
        ],
        "records": {
            "STUDYID": [
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
                "CDISCPILOT01",
            ],
            "RDOMAIN": [
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
                "EC",
            ],
            "USUBJID": [
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
                "CDISC001",
            ],
            "IDVAR": [
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
                "ECSEQ",
            ],
            "IDVARVAL": [1, 2, 3, 4, 5, 6, 7, 8, 11, 13, 14],
            "QNAM": [
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
                "ECREASOC",
            ],
            "QLABEL": [
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
                "Reason for Occur Value",
            ],
            "QVAL": [
                "SAME",
                "SAME",
                "DIFF3",
                "SAME",
                "DIFF5",
                "DIFF6",
                "SAME",
                "SAME",
                "SAME",
                "DIFF13",
                "SAME",
            ],
            "QORIG": [
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
                "COLLECTED",
            ],
            "QEVAL": [
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
                "INVESTIGATOR",
            ],
        },
    },
]

define_metadata = {
    "ecaa.xpt": {
        "define_dataset_name": "ECAA",
        "define_dataset_label": "ECAA label",
        "define_dataset_location": "ecaa.xpt",
        "define_dataset_class": "EVENTS",
        "define_dataset_structure": "One record per trial summary parameter value",
        "define_dataset_is_non_standard": "",
    },
    "ecbb.xpt": {
        "define_dataset_name": "ECBB",
        "define_dataset_label": "ECBB label",
        "define_dataset_location": "ecbb.xpt",
        "define_dataset_class": "EVENTS",
        "define_dataset_structure": "One record per subject",
        "define_dataset_is_non_standard": "",
    },
    "suppec.xpt": {
        "define_dataset_name": "SUPPEC",
        "define_dataset_label": "Suppqual for EC",
        "define_dataset_location": "suppec.xpt",
        "define_dataset_class": "RELATIONSHIP",
        "define_dataset_structure": "One record per adverse event",
        "define_dataset_is_non_standard": "",
    },
}

data_metadata = {
    "dataset_size": [10, 0, 1000],
    "dataset_location": ["ts.xpt", "dm.xpt", "ae.xpt"],
    "dataset_name": ["TS", "DM", "AE"],
    "dataset_label": ["Trial Summary", "Demographics", "Adverse Events"],
}

dataset_metadata = {
    "ecaa.xpt": {
        "name": "ECAA",
        "first_record": {"DOMAIN": "EC"},
        "filename": "ecaa.xpt",
    },
    "ecbb.xpt": {
        "name": "ECBB",
        "first_record": {"DOMAIN": "EC"},
        "filename": "ecbb.xpt",
    },
    "suppec.xpt": {
        "name": "SUPPEC",
        "first_record": {"RDOMAIN": "EC"},
        "filename": "suppec.xpt",
    },
}

expected_results = {
    "ecaa.xpt": {
        "STUDYID": [
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
        ],
        "DOMAIN": ["EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC"],
        "USUBJID": [
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
        ],
        "SPDEVID": [
            "Different",
            "Different",
            "Same as split, different supp",
            "Same as split, same supp",
            "Same as next row, different supp",
            "Same as prev row, different supp",
            "Same as next row, same supp",
            "Same as prev row, same supp",
        ],
        "ECSEQ": [1, 2, 3, 4, 5, 6, 7, 8],
        "ECTRT": [
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
            "ZANOMALINE",
        ],
        "ECDOSE": [5, 5, 5, 5, 5, 5, 5, 5],
        "ECSTDTC": [
            "2012-11-30",
            "2012-12-01",
            "2012-12-02",
            "2012-12-03",
            "2012-12-04",
            "2012-12-04",
            "2012-12-05",
            "2012-12-05",
        ],
        "dataset_size": [1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000],
        "dataset_name": [
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
        ],
        "dataset_label": [
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
            "Exposure as Collected AA",
        ],
        "dataset_location": [
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
        ],
        "record_count": [8, 8, 8, 8, 8, 8, 8, 8],
        "define_dataset_name": [
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
            "ECAA",
        ],
        "define_dataset_label": [
            "ECAA label",
            "ECAA label",
            "ECAA label",
            "ECAA label",
            "ECAA label",
            "ECAA label",
            "ECAA label",
            "ECAA label",
        ],
        "define_dataset_location": [
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
            "ecaa.xpt",
        ],
        "define_dataset_class": [
            "EVENTS",
            "EVENTS",
            "EVENTS",
            "EVENTS",
            "EVENTS",
            "EVENTS",
            "EVENTS",
            "EVENTS",
        ],
        "define_dataset_structure": [
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
            "One record per trial summary parameter value",
        ],
        "define_dataset_is_non_standard": ["", "", "", "", "", "", "", ""],
    },
    "ecbb.xpt": {
        "STUDYID": ["CDISCPILOT01", "CDISCPILOT01", "CDISCPILOT01"],
        "DOMAIN": ["EC", "EC", "EC"],
        "USUBJID": ["CDISC001", "CDISC001", "CDISC001"],
        "SPDEVID": [
            "Different",
            "Same as split, different supp",
            "Same as split, same supp",
        ],
        "ECSEQ": [11, 13, 14],
        "ECTRT": ["ZANOMALINE", "ZANOMALINE", "ZANOMALINE"],
        "ECDOSE": [5, 5, 5],
        "ECSTDTC": ["2013-12-01", "2012-12-02", "2012-12-03"],
        "dataset_size": [1000, 1000, 1000],
        "dataset_name": ["ECBB", "ECBB", "ECBB"],
        "dataset_label": [
            "Exposure as Collected BB",
            "Exposure as Collected BB",
            "Exposure as Collected BB",
        ],
        "dataset_location": ["ecbb.xpt", "ecbb.xpt", "ecbb.xpt"],
        "record_count": [3, 3, 3],
        "define_dataset_name": ["ECBB", "ECBB", "ECBB"],
        "define_dataset_label": ["ECBB label", "ECBB label", "ECBB label"],
        "define_dataset_location": ["ecbb.xpt", "ecbb.xpt", "ecbb.xpt"],
        "define_dataset_class": ["EVENTS", "EVENTS", "EVENTS"],
        "define_dataset_structure": [
            "One record per subject",
            "One record per subject",
            "One record per subject",
        ],
        "define_dataset_is_non_standard": ["", "", ""],
    },
    "suppec.xpt": {
        "STUDYID": [
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
            "CDISCPILOT01",
        ],
        "RDOMAIN": ["EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC", "EC"],
        "USUBJID": [
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
            "CDISC001",
        ],
        "IDVAR": [
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
            "ECSEQ",
        ],
        "IDVARVAL": [1, 2, 3, 4, 5, 6, 7, 8, 11, 13, 14],
        "QNAM": [
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
            "ECREASOC",
        ],
        "QLABEL": [
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
            "Reason for Occur Value",
        ],
        "QVAL": [
            "SAME",
            "SAME",
            "DIFF3",
            "SAME",
            "DIFF5",
            "DIFF6",
            "SAME",
            "SAME",
            "SAME",
            "DIFF13",
            "SAME",
        ],
        "QORIG": [
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
            "COLLECTED",
        ],
        "QEVAL": [
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
            "INVESTIGATOR",
        ],
        "dataset_size": [
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
            1000,
        ],
        "dataset_name": [
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
        ],
        "dataset_label": [
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
            "Supplemental Qualifiers for EC",
        ],
        "dataset_location": [
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
        ],
        "record_count": [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],
        "define_dataset_name": [
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
            "SUPPEC",
        ],
        "define_dataset_label": [
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
            "Suppqual for EC",
        ],
        "define_dataset_location": [
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
            "suppec.xpt",
        ],
        "define_dataset_class": [
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
            "RELATIONSHIP",
        ],
        "define_dataset_structure": [
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
            "One record per adverse event",
        ],
        "define_dataset_is_non_standard": ["", "", "", "", "", "", "", "", "", "", ""],
    },
}


@pytest.mark.parametrize(
    "dataset_path",
    [
        "ecaa.xpt",
        "ecbb.xpt",
        "suppec.xpt",
    ],
)
def test_contents_define_dataset_builder(dataset_path):
    cache_mock = MagicMock()
    cache_mock.get_dataset.return_value = None
    builder = ContentsDefineDatasetBuilder(
        rule={
            "conditions": ConditionCompositeFactory.get_condition_composite({}),
        },
        data_service=DummyDataService(
            cache_mock,
            MagicMock(),
            MagicMock(),
            data=[DummyDataset(dataset) for dataset in datasets],
        ),
        cache_service=None,
        rule_processor=RuleProcessor(mock_data_service, InMemoryCacheService()),
        data_processor=None,
        dataset_path=dataset_path,
        datasets=[
            SDTMDatasetMetadata(**dataset) for dataset in dataset_metadata.values()
        ],
        dataset_metadata=SDTMDatasetMetadata(**dataset_metadata[dataset_path]),
        define_xml_path=None,
        standard="sdtmig",
        standard_version="3-4",
        standard_substandard=None,
        library_metadata=LibraryMetadataContainer(),
    )

    with patch.object(
        builder,
        "get_define_xml_item_group_metadata_for_dataset",
        return_value=define_metadata[dataset_path],
    ):
        result = builder.build()

    # print(result.data.to_dict("list"))

    # Ensure columns are in the expected order
    expected_df = pd.DataFrame(expected_results[dataset_path])
    result_df = result.data[expected_df.columns]

    # Check that columns are the same
    assert list(result_df.columns) == list(expected_df.columns), "Columns do not match"

    # Check that the values in each column match
    pd.testing.assert_frame_equal(result_df, expected_df)
